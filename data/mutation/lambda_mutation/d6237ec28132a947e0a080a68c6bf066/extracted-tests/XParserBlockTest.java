package org.xcsp.parser;

import org.blocktest.BTest;
import static org.blocktest.BTest.blocktest;
import static org.blocktest.types.EndAt.*;
import static org.blocktest.utils.Constant.*;
import static org.xcsp.common.Constants.ANNOTATIONS;
import static org.xcsp.common.Constants.BLOCK;
import static org.xcsp.common.Constants.CONSTRAINTS;
import static org.xcsp.common.Constants.DECISION;
import static org.xcsp.common.Constants.DELIMITER_LISTS;
import static org.xcsp.common.Constants.DELIMITER_MSETS;
import static org.xcsp.common.Constants.DELIMITER_SETS;
import static org.xcsp.common.Constants.DOMAIN;
import static org.xcsp.common.Constants.GROUP;
import static org.xcsp.common.Constants.MAX_SAFE_BYTE;
import static org.xcsp.common.Constants.MAX_SAFE_INT;
import static org.xcsp.common.Constants.MAX_SAFE_SHORT;
import static org.xcsp.common.Constants.MINIMIZE;
import static org.xcsp.common.Constants.MIN_SAFE_BYTE;
import static org.xcsp.common.Constants.MIN_SAFE_INT;
import static org.xcsp.common.Constants.MIN_SAFE_SHORT;
import static org.xcsp.common.Constants.OBJECTIVES;
import static org.xcsp.common.Constants.STAR;
import static org.xcsp.common.Constants.STAR_SYMBOL;
import static org.xcsp.common.Constants.STATIC;
import static org.xcsp.common.Constants.TIMES;
import static org.xcsp.common.Constants.VAL_HEURISTIC;
import static org.xcsp.common.Constants.VAR;
import static org.xcsp.common.Constants.VARIABLES;
import static org.xcsp.common.Types.TypeChild.FINAL;
import static org.xcsp.common.Types.TypeChild.arcs;
import static org.xcsp.common.Types.TypeChild.balance;
import static org.xcsp.common.Types.TypeChild.coeffs;
import static org.xcsp.common.Types.TypeChild.colOccurs;
import static org.xcsp.common.Types.TypeChild.condition;
import static org.xcsp.common.Types.TypeChild.conditions;
import static org.xcsp.common.Types.TypeChild.cost;
import static org.xcsp.common.Types.TypeChild.ends;
import static org.xcsp.common.Types.TypeChild.except;
import static org.xcsp.common.Types.TypeChild.function;
import static org.xcsp.common.Types.TypeChild.graph;
import static org.xcsp.common.Types.TypeChild.heights;
import static org.xcsp.common.Types.TypeChild.image;
import static org.xcsp.common.Types.TypeChild.index;
import static org.xcsp.common.Types.TypeChild.lengths;
import static org.xcsp.common.Types.TypeChild.limits;
import static org.xcsp.common.Types.TypeChild.list;
import static org.xcsp.common.Types.TypeChild.loads;
import static org.xcsp.common.Types.TypeChild.machines;
import static org.xcsp.common.Types.TypeChild.mapping;
import static org.xcsp.common.Types.TypeChild.matrix;
import static org.xcsp.common.Types.TypeChild.occurs;
import static org.xcsp.common.Types.TypeChild.operator;
import static org.xcsp.common.Types.TypeChild.origins;
import static org.xcsp.common.Types.TypeChild.patterns;
import static org.xcsp.common.Types.TypeChild.profits;
import static org.xcsp.common.Types.TypeChild.root;
import static org.xcsp.common.Types.TypeChild.rowOccurs;
import static org.xcsp.common.Types.TypeChild.rules;
import static org.xcsp.common.Types.TypeChild.set;
import static org.xcsp.common.Types.TypeChild.size;
import static org.xcsp.common.Types.TypeChild.sizes;
import static org.xcsp.common.Types.TypeChild.start;
import static org.xcsp.common.Types.TypeChild.terminal;
import static org.xcsp.common.Types.TypeChild.total;
import static org.xcsp.common.Types.TypeChild.transitions;
import static org.xcsp.common.Types.TypeChild.value;
import static org.xcsp.common.Types.TypeChild.values;
import static org.xcsp.common.Types.TypeChild.weights;
import static org.xcsp.common.Types.TypeChild.widths;
import static org.xcsp.common.Types.TypeConditionOperatorRel.EQ;
import static org.xcsp.common.Types.TypeConditionOperatorSet.IN;
import static org.xcsp.common.Types.TypeConditionOperatorSet.NOTIN;
import static org.xcsp.common.Utilities.childElementsOf;
import static org.xcsp.common.Utilities.control;
import static org.xcsp.common.Utilities.isLong;
import static org.xcsp.common.Utilities.isTag;
import static org.xcsp.common.Utilities.safeInt;
import static org.xcsp.common.Utilities.safeLong;
import static org.xcsp.common.Utilities.splitToInts;
import java.io.InputStream;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.StringTokenizer;
import java.util.concurrent.atomic.AtomicBoolean;
import java.util.stream.Collectors;
import java.util.stream.IntStream;
import java.util.stream.Stream;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.xpath.XPath;
import javax.xml.xpath.XPathConstants;
import javax.xml.xpath.XPathExpressionException;
import javax.xml.xpath.XPathFactory;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.NodeList;
import org.xcsp.common.Condition;
import org.xcsp.common.Condition.ConditionIntset;
import org.xcsp.common.Condition.ConditionIntvl;
import org.xcsp.common.Condition.ConditionPar1;
import org.xcsp.common.Condition.ConditionPar2;
import org.xcsp.common.Condition.ConditionVal;
import org.xcsp.common.Constants;
import org.xcsp.common.Softening;
import org.xcsp.common.Softening.SofteningExtension;
import org.xcsp.common.Softening.SofteningGlobal;
import org.xcsp.common.Softening.SofteningIntension;
import org.xcsp.common.Softening.SofteningSimple;
import org.xcsp.common.Types;
import org.xcsp.common.Types.TypeAtt;
import org.xcsp.common.Types.TypeChild;
import org.xcsp.common.Types.TypeClass;
import org.xcsp.common.Types.TypeCombination;
import org.xcsp.common.Types.TypeConditionOperator;
import org.xcsp.common.Types.TypeConditionOperatorRel;
import org.xcsp.common.Types.TypeConditionOperatorSet;
import org.xcsp.common.Types.TypeCtr;
import org.xcsp.common.Types.TypeExpr;
import org.xcsp.common.Types.TypeFlag;
import org.xcsp.common.Types.TypeFramework;
import org.xcsp.common.Types.TypeMeasure;
import org.xcsp.common.Types.TypeObjective;
import org.xcsp.common.Types.TypeOperator;
import org.xcsp.common.Types.TypeReification;
import org.xcsp.common.Types.TypeVar;
import org.xcsp.common.Utilities;
import org.xcsp.common.domains.Domains.Dom;
import org.xcsp.common.domains.Domains.DomBasic;
import org.xcsp.common.domains.Domains.DomGraph;
import org.xcsp.common.domains.Domains.DomSet;
import org.xcsp.common.domains.Domains.DomSymbolic;
import org.xcsp.common.domains.Domains.IDom;
import org.xcsp.common.domains.Values.Decimal;
import org.xcsp.common.domains.Values.IntegerEntity;
import org.xcsp.common.domains.Values.IntegerInterval;
import org.xcsp.common.domains.Values.Occurrences;
import org.xcsp.common.domains.Values.Rational;
import org.xcsp.common.predicates.XNode;
import org.xcsp.common.predicates.XNodeLeaf;
import org.xcsp.common.predicates.XNodeParent;
import org.xcsp.common.structures.AbstractTuple;
import org.xcsp.common.structures.AbstractTuple.HybridTuple;
import org.xcsp.common.structures.AbstractTuple.OrdinaryTuple;
import org.xcsp.common.structures.Transition;
import org.xcsp.parser.entries.ParsingEntry.AEntry;
import org.xcsp.parser.entries.ParsingEntry.CEntry;
import org.xcsp.parser.entries.ParsingEntry.OEntry;
import org.xcsp.parser.entries.ParsingEntry.VEntry;
import org.xcsp.parser.entries.XConstraints.CChild;
import org.xcsp.parser.entries.XConstraints.CEntryReifiable;
import org.xcsp.parser.entries.XConstraints.XBlock;
import org.xcsp.parser.entries.XConstraints.XCtr;
import org.xcsp.parser.entries.XConstraints.XGroup;
import org.xcsp.parser.entries.XConstraints.XLogic;
import org.xcsp.parser.entries.XConstraints.XParameter;
import org.xcsp.parser.entries.XConstraints.XReification;
import org.xcsp.parser.entries.XConstraints.XSeqbin;
import org.xcsp.parser.entries.XConstraints.XSlide;
import org.xcsp.parser.entries.XObjectives.OObjectiveExpr;
import org.xcsp.parser.entries.XObjectives.OObjectiveSpecial;
import org.xcsp.parser.entries.XVariables.XArray;
import org.xcsp.parser.entries.XVariables.XVar;
import org.xcsp.parser.entries.XVariables.XVarInteger;
import org.xcsp.parser.loaders.CtrLoaderInteger;
import org.junit.Test;
import static org.junit.Assert.*;
import static org.xcsp.parser.XParser.*;

public class XParserBlockTest {

    @Test
    public void test() throws Exception {
        XArray array = null;
        TypeVar type = null;
        Element child = null;
        Map<String, IDom> cacheForId2Domain = new HashMap<>();
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        javax.xml.parsers.DocumentBuilder builder = factory.newDocumentBuilder();
        Document document = builder.newDocument();
        Element actualForChild = document.createElement("book");
        child = actualForChild;
        actualForChild.setAttribute(TypeAtt.id.name(), "fun");
        actualForChild.setAttribute("for", "test");
        IDom domChild = cacheForId2Domain.get(actualForChild.getAttribute(TypeAtt.id.name()));
        if (domChild == null) {
            domChild = new Dom(5, 10);
            String idChild = child.getAttribute(TypeAtt.id.name());
            if (idChild.length() > 0)
                cacheForId2Domain.put(idChild, domChild);
        }
        assertEquals((new Dom(5, 10)).toString(), cacheForId2Domain.get("fun").toString());
        assertFalse(cacheForId2Domain.isEmpty());
    }

    @Test
    public void test2() throws Exception {
        XArray array = null;
        TypeVar type = null;
        Element child = null;
        Map<String, IDom> cacheForId2Domain = new HashMap<>();
        DocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();
        javax.xml.parsers.DocumentBuilder builder = factory.newDocumentBuilder();
        Document document = builder.newDocument();
        Element actualForChild = document.createElement("book");
        child = actualForChild;
        actualForChild.setAttribute(TypeAtt.id.name(), "");
        actualForChild.setAttribute("for", "test");
        IDom domChild = cacheForId2Domain.get(actualForChild.getAttribute(TypeAtt.id.name()));
        if (domChild == null) {
            domChild = new Dom(5, 10);
            String idChild = child.getAttribute(TypeAtt.id.name());
            if (idChild.length() > 0)
                cacheForId2Domain.put(idChild, domChild);
        }
        assertTrue(cacheForId2Domain.isEmpty());
    }
}
